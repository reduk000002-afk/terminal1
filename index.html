<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Фьючерсный терминал</title>
  <!-- Подключение Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      overflow-x: hidden;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      -webkit-text-size-adjust: 100%;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      background: #161b22;
      padding: 10px max(20px, env(safe-area-inset-right));
      padding-left: max(20px, env(safe-area-inset-left));
      border-bottom: 1px solid #30363d;
      position: sticky;
      top: 0;
      z-index: 101;
      font-size: 14px;
      align-items: center;
      height: 60px;
      width: 100%;
    }

    .balance-info {
      display: flex;
      gap: 15px;
      align-items: center;
      overflow-x: auto;
      white-space: nowrap;
      max-width: 60%;
    }

    .balance-item {
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .balance-label {
      color: #8b949e;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .balance-value {
      font-weight: bold;
      font-size: 13px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      flex-shrink: 0;
    }

    .menu-toggle {
      background: none;
      border: none;
      color: #c9d1d9;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu-toggle:hover {
      background-color: #21262d;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
      margin-top: 5px;
    }

    .dropdown-menu.active {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    .menu-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      border-bottom: 1px solid #21262d;
      min-height: 44px;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background-color: #21262d;
    }

    .menu-item img {
      width: 18px;
      height: 18px;
      filter: brightness(0.8);
    }

    .positive {
      color: #16c784;
    }

    .negative {
      color: #ea3943;
    }

    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #0d1117;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      z-index: 1000;
      padding-top: 80px;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .login-form {
      background: #161b22;
      padding: 30px;
      border-radius: 10px;
      border: 1px solid #30363d;
      width: calc(100% - 40px);
      max-width: 400px;
      margin-top: 20px;
      margin-left: 20px;
      margin-right: 20px;
    }

    .login-form h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #f0f6fc;
    }

    .login-form input {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      background: #0d1117;
      border: 1px solid #30363d;
      color: white;
      border-radius: 5px;
      font-size: 16px;
      min-height: 50px;
    }

    .login-form button {
      width: 100%;
      padding: 15px;
      background-color: #1f6feb;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      min-height: 50px;
    }

    .login-error {
      color: #f85149;
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      display: none;
    }

    .register-link {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: #8b949e;
    }

    .register-link a {
      color: #1f6feb;
      text-decoration: none;
      font-weight: 500;
    }

    .main-container {
      display: flex;
      min-height: calc(100vh - 60px);
    }

    .market-column {
      width: 280px;
      background: #161b22;
      border-right: 1px solid #30363d;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .layout {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .sidebar {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      background: #161b22;
      padding: 10px 0;
      border-bottom: 1px solid #30363d;
      position: sticky;
      top: 60px;
      z-index: 100;
    }

    .sidebar-item {
      text-align: center;
      font-size: 12px;
      color: #c9d1d9;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 60px;
      padding: 10px 5px;
      border-radius: 5px;
      transition: background-color 0.2s;
      min-height: 44px;
    }

    .sidebar-item:hover, .sidebar-item.active {
      background-color: #21262d;
    }

    .sidebar-item img {
      width: 20px;
      height: 20px;
      margin-bottom: 5px;
    }

    .page-content {
      flex: 1;
      padding: 20px;
      padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
      overflow-y: auto;
      display: none;
      width: 100%;
      box-sizing: border-box;
    }

    .page-content.active {
      display: block;
    }

    .chart-section {
      background: #0d1117;
      position: relative;
      display: flex;
      flex-direction: column;
      height: 50vh;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .chart-section iframe {
      flex: 1;
      width: 100%;
      border: none;
      min-height: 300px;
      border-radius: 0 0 8px 8px;
    }

    .deal-display {
      background: #0d1117;
      border-top: 1px solid #30363d;
      padding: 15px;
      font-family: monospace;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 30vh;
      overflow-y: auto;
    }

    .deal-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
    }

    .deal-column {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .terminal-section {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      overflow-y: auto;
      transition: transform 0.3s ease, margin-top 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }

    .selector-container {
      margin-bottom: 15px;
      position: relative;
      width: 100%;
    }

    .selector-button {
      width: 100%;
      padding: 15px;
      background: #0d1117;
      color: white;
      border: 1px solid #30363d;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
      font-size: 16px;
      min-height: 50px;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(22, 27, 34, 0.95);
      border: 1px solid #30363d;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }

    .dropdown input {
      width: 100%;
      padding: 15px;
      background: #0d1117;
      color: white;
      border: none;
      border-bottom: 1px solid #30363d;
      font-size: 16px;
      min-height: 50px;
    }

    .dropdown div {
      padding: 15px;
      cursor: pointer;
      font-size: 16px;
      min-height: 44px;
    }

    .dropdown div:hover {
      background: #21262d;
    }

    .terminal-section select,
    .terminal-section input[type="number"] {
      width: 100%;
      padding: 15px;
      background: #0d1117;
      border: 1px solid #30363d;
      color: white;
      border-radius: 5px;
      margin-bottom: 15px;
      font-size: 16px;
      min-height: 50px;
    }

    .btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
      transition: opacity 0.2s;
      min-height: 50px;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-long {
      background-color: #16c784;
      color: white;
    }

    .btn-short {
      background-color: #ea3943;
      color: white;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      font-size: 16px;
      gap: 10px;
      min-height: 44px;
    }

    .checkbox-group input {
      width: 20px;
      height: 20px;
      min-width: 20px;
    }

    .tp-sl {
      display: none;
      margin-bottom: 15px;
    }

    .tp-sl input {
      width: 100%;
      margin-bottom: 10px;
      padding: 15px;
      min-height: 50px;
      font-size: 16px;
    }

    .flex-space {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .info-line {
      font-size: 15px;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .leverage-display {
      text-align: center;
      margin: 10px 0 20px;
      font-size: 16px;
    }

    .market-info {
      background: #161b22;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #30363d;
    }

    .market-info div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 15px;
    }

    .market-info div:last-child {
      margin-bottom: 0;
    }

    .title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .positions-title {
      padding: 15px;
      font-weight: bold;
      border-bottom: 1px solid #30363d;
      background: #161b22;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 44px;
      font-size: 16px;
      border-radius: 6px 6px 0 0;
      transition: all 0.2s ease;
      margin: 0;
    }

    .positions-title:hover {
      background: #1a2029;
    }

    .positions-title::after {
      content: "▼";
      font-size: 14px;
      transition: transform 0.3s;
    }

    .positions-title.expanded::after {
      transform: rotate(180deg);
    }

    .deal-block {
      border-bottom: 1px solid #30363d;
      padding: 15px;
      transition: background-color 0.2s;
      font-size: 15px;
      background: #0d1117;
    }

    .deal-block:hover {
      background-color: #161b22;
    }

    .section-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #8b949e;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .watchlist-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #21262d;
      cursor: pointer;
      transition: background-color 0.2s;
      min-height: 44px;
    }

    .watchlist-item:hover {
      background-color: #21262d;
    }

    .asset-name {
      font-weight: bold;
      font-size: 15px;
    }

    .asset-price {
      font-size: 15px;
    }

    .asset-change {
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .quick-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .quick-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      transition: background-color 0.2s;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quick-btn:hover {
      background: #30363d;
    }

    .portfolio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .portfolio-bar {
      height: 8px;
      background: #30363d;
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .portfolio-fill {
      height: 100%;
      border-radius: 4px;
    }

    .market-stats {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 10px;
      gap: 15px;
    }

    .stat-item {
      text-align: center;
      flex: 1;
    }

    .stat-value {
      font-weight: bold;
      font-size: 16px;
    }

    .stat-label {
      color: #8b949e;
      font-size: 13px;
    }

    .profile-container {
      max-width: 900px;
      margin: 0 auto;
      background: #161b22;
      padding: 30px;
      border: 1px solid #30363d;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      box-sizing: border-box;
    }

    .profile-section {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-top: 25px;
      border-top: 1px solid #30363d;
      padding-top: 20px;
    }

    .profile-column {
      flex: 1;
      margin: 10px;
      min-width: 300px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
      padding: 12px 0;
      border-bottom: 1px solid #21262d;
      font-size: 16px;
    }

    .label {
      font-weight: 600;
      color: #8b949e;
    }

    .profile-btn {
      background-color: #238636;
      border: none;
      padding: 12px 20px;
      color: white;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
      transition: background-color 0.2s;
      font-size: 16px;
      min-height: 44px;
    }

    .profile-btn:hover {
      background-color: #2ea043;
    }

    .btn-secondary {
      background-color: #21262d;
      border: 1px solid #30363d;
    }

    .btn-secondary:hover {
      background-color: #30363d;
    }

    .btn-kyc {
      background-color: #1f6feb;
      width: 100%;
      padding: 15px;
      margin-top: 15px;
    }

    .btn-kyc:hover {
      background-color: #2b7ff5;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-verified {
      background-color: rgba(35, 134, 54, 0.2);
      color: #3fb950;
    }

    .status-pending {
      background-color: rgba(187, 128, 9, 0.2);
      color: #d29922;
    }

    .kyc-message {
      background-color: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      font-size: 16px;
      line-height: 1.5;
    }

    .file-upload {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }

    .file-upload label {
      margin-bottom: 10px;
      font-weight: 500;
      color: #8b949e;
      font-size: 16px;
    }

    .file-input {
      background-color: #0d1117;
      color: white;
      border: 1px solid #30363d;
      padding: 15px;
      border-radius: 6px;
      font-size: 16px;
      min-height: 50px;
    }

    .user-id {
      display: flex;
      align-items: center;
      background-color: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .user-email {
      display: flex;
      align-items: center;
      background-color: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .balance-info-section {
      background: #161b22;
      padding: 25px;
      border: 1px solid #30363d;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      box-sizing: border-box;
    }

    .wallet-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .wallet-tab {
      background: #21262d;
      padding: 15px 20px;
      border-radius: 8px;
      border: 1px solid #30363d;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-height: 44px;
      flex: 1;
      min-width: 120px;
      justify-content: center;
    }

    .wallet-tab:hover {
      background: #30363d;
    }

    .wallet-tab.active {
      background: #1f6feb;
      border-color: #1f6feb;
      box-shadow: 0 2px 8px rgba(31, 111, 235, 0.3);
    }

    .wallet-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .wallet-content.active {
      display: block;
    }

    .qr-code-container {
      text-align: center;
      margin: 20px 0;
      padding: 20px;
      background: #0d1117;
      border-radius: 10px;
      border: 1px solid #30363d;
    }

    .wallet-address {
      background: #161b22;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      word-break: break-all;
      margin: 20px 0;
      text-align: center;
      font-size: 16px;
      border: 1px solid #30363d;
      color: #f0f6fc;
    }

    .wallet-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .wallet-btn {
      padding: 15px 25px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s ease;
      min-width: 160px;
      min-height: 50px;
    }

    .copy-btn {
      background-color: #1f6feb;
      color: white;
      border: 1px solid #1f6feb;
    }

    .copy-btn:hover {
      background-color: #2b7ff5;
      box-shadow: 0 2px 8px rgba(31, 111, 235, 0.3);
    }

    .copy-btn.copied {
      background-color: #238636;
      border-color: #238636;
    }

    .history-section {
      background: #161b22;
      padding: 25px;
      border: 1px solid #30363d;
      border-radius: 10px;
      margin-top: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      width: 100%;
      box-sizing: border-box;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }

    .history-table th {
      text-align: left;
      padding: 15px;
      border-bottom: 1px solid #30363d;
      color: #58a6ff;
      font-weight: 600;
      font-size: 15px;
    }

    .history-table td {
      padding: 15px;
      border-bottom: 1px solid #21262d;
      color: #f0f6fc;
    }

    .empty-history {
      text-align: center;
      padding: 40px 20px;
      color: #8b949e;
      font-size: 16px;
    }

    .network-info {
      color: #8b949e;
      font-size: 15px;
      margin-top: 10px;
      text-align: center;
    }

    .withdraw-alert {
      color: #f85149;
      background: rgba(248, 81, 73, 0.1);
      padding: 20px;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 25px;
      border: 1px solid rgba(248, 81, 73, 0.3);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .withdraw-form {
      background: #161b22;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #30363d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
      width: 100%;
      box-sizing: border-box;
    }

    .withdraw-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .withdraw-tab {
      padding: 15px 25px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s ease;
      min-height: 44px;
      flex: 1;
      min-width: 160px;
      text-align: center;
    }

    .withdraw-tab:hover {
      background: #30363d;
    }

    .withdraw-tab.active {
      background: #1f6feb;
      color: white;
      border-color: #1f6feb;
      box-shadow: 0 2px 8px rgba(31, 111, 235, 0.3);
    }

    .form-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .form-section.active {
      display: block;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 25px;
    }

    .form-group label {
      margin-bottom: 10px;
      font-weight: 500;
      color: #8b949e;
      font-size: 16px;
    }

    .form-group input {
      padding: 15px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #0d1117;
      color: #f0f6fc;
      font-size: 16px;
      transition: border-color 0.2s;
      min-height: 50px;
    }

    .submit-btn {
      background: #1f6feb;
      color: white;
      padding: 18px 25px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
      margin-top: 20px;
      min-height: 55px;
    }

    .balance-display {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 25px;
      width: 100%;
      box-sizing: border-box;
    }

    .balance-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #21262d;
      font-size: 16px;
    }

    .balance-row:last-child {
      border-bottom: none;
    }

    .balance-label {
      color: #8b949e;
      font-size: 16px;
    }

    .balance-amount {
      font-size: 18px;
      font-weight: 600;
      color: #f0f6fc;
    }

    .total-balance {
      background: linear-gradient(135deg, #1f6feb, #2b7ff5);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 25px;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }

    .total-balance-label {
      color: rgba(255, 255, 255, 0.9);
      font-size: 18px;
      margin-bottom: 15px;
    }

    .total-balance-amount {
      font-size: 32px;
      font-weight: 700;
      color: white;
    }

    .balance-currency {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      margin-left: 10px;
    }

    .available-balance {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      width: 100%;
      box-sizing: border-box;
    }

    .available-balance-label {
      color: #8b949e;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .available-balance-amount {
      font-size: 22px;
      font-weight: 600;
      color: #f0f6fc;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 10000;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .modal-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: #161b22;
      border-radius: 16px;
      border: 1px solid #30363d;
      max-width: 500px;
      width: calc(100% - 40px);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalAppear 0.3s ease;
      margin: 20px;
    }

    .modal-header {
      padding: 25px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      color: #f0f6fc;
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: #8b949e;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .modal-body {
      padding: 25px;
    }

    .modal-message {
      color: #c9d1d9;
      line-height: 1.6;
      margin-bottom: 20px;
      font-size: 16px;
    }

    .commission-warning {
      background: rgba(248, 81, 73, 0.1);
      border: 1px solid rgba(248, 81, 73, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .commission-list {
      list-style: none;
      margin: 20px 0;
      padding: 0;
    }

    .commission-list li {
      padding: 8px 0;
      color: #8b949e;
      font-size: 15px;
    }

    .commission-total {
      font-weight: 600;
      color: #f85149 !important;
      font-size: 17px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #30363d;
    }

    .modal-footer {
      padding: 25px;
      border-top: 1px solid #30363d;
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .modal-btn {
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 50px;
      flex: 1;
      min-width: 120px;
    }

    .modal-btn-cancel {
      background: #21262d;
      color: #c9d1d9;
      border: 1px solid #30363d;
    }

    .modal-btn-confirm {
      background: #1f6feb;
      color: white;
    }

    .checkbox-container {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(248, 81, 73, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(248, 81, 73, 0.2);
    }

    .support-message {
      text-align: center;
      padding: 25px 0;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #f85149;
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      display: none;
      animation: slideIn 0.3s ease;
      max-width: calc(100% - 40px);
    }

    .success-checkmark {
      text-align: center;
      margin: 25px 0;
    }

    .check-icon {
      width: 80px;
      height: 80px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 4px solid #16c784;
      margin: 0 auto;
    }

    .check-icon::before {
      top: 3px;
      left: -2px;
      width: 30px;
      transform-origin: 100% 50%;
      border-radius: 100px 0 0 100px;
    }

    .check-icon::after {
      top: 0;
      left: 30px;
      width: 60px;
      transform-origin: 0 50%;
      border-radius: 0 100px 100px 0;
      animation: rotate-circle 4.25s ease-in;
    }

    .check-icon::before, .check-icon::after {
      content: '';
      height: 100px;
      position: absolute;
      background: #161b22;
      transform: rotate(-45deg);
    }

    .icon-line {
      height: 5px;
      background-color: #16c784;
      display: block;
      border-radius: 2px;
      position: absolute;
      z-index: 10;
    }

    .icon-line.line-tip {
      top: 46px;
      left: 14px;
      width: 25px;
      transform: rotate(45deg);
      animation: icon-line-tip 0.75s;
    }

    .icon-line.line-long {
      top: 38px;
      right: 8px;
      width: 47px;
      transform: rotate(-45deg);
      animation: icon-line-long 0.75s;
    }

    .icon-circle {
      top: -4px;
      left: -4px;
      z-index: 10;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: absolute;
      box-sizing: content-box;
      border: 4px solid rgba(22, 199, 132, 0.5);
    }

    .icon-fix {
      top: 8px;
      width: 5px;
      left: 26px;
      z-index: 1;
      height: 85px;
      position: absolute;
      transform: rotate(-45deg);
      background-color: #161b22;
    }

    .normal-withdraw-info {
      background: rgba(22, 199, 132, 0.1);
      border: 1px solid rgba(22, 199, 132, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .withdraw-details {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin: 12px 0;
      font-size: 16px;
    }

    .fee-amount {
      color: #8b949e;
    }

    .receive-amount {
      color: #16c784;
      font-weight: bold;
    }

    .countdown-timer {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #1f6feb;
      margin: 20px 0;
    }

    /* НОВЫЕ СТИЛИ ДЛЯ ПОЗИЦИЙ С СУПАБЕЙЗ */
    .position-status {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
      margin-left: 15px;
      min-width: 120px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-processing {
      background: rgba(255, 170, 0, 0.15);
      color: #ffaa00;
      border: 1px solid rgba(255, 170, 0, 0.3);
    }

    .status-closed {
      background: rgba(22, 199, 132, 0.15);
      color: #16c784;
      border: 1px solid rgba(22, 199, 132, 0.3);
    }

    .position-pnl {
      font-size: 13px;
      font-weight: 500;
    }

    .pnl-positive {
      color: #16c784;
    }

    .pnl-negative {
      color: #ea3943;
    }

    /* ОБНОВЛЕННЫЙ .deal-block ДЛЯ ПОЗИЦИЙ */
    .deal-block {
      border-bottom: 1px solid #30363d;
      padding: 15px;
      transition: background-color 0.2s;
      font-size: 15px;
      background: #0d1117;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .deal-block:hover {
      background-color: #161b22;
    }

    .deal-info {
      flex: 1;
    }

    @keyframes rotate-circle {
      0% { transform: rotate(-45deg); }
      5% { transform: rotate(-45deg); }
      12% { transform: rotate(-405deg); }
      100% { transform: rotate(-405deg); }
    }

    @keyframes icon-line-tip {
      0% { width: 0; left: 1px; top: 19px; }
      54% { width: 0; left: 1px; top: 19px; }
      70% { width: 50px; left: -8px; top: 37px; }
      84% { width: 17px; left: 21px; top: 48px; }
      100% { width: 25px; left: 14px; top: 45px; }
    }

    @keyframes icon-line-long {
      0% { width: 0; right: 46px; top: 54px; }
      65% { width: 0; right: 46px; top: 54px; }
      84% { width: 55px; right: 0px; top: 35px; }
      100% { width: 47px; right: 8px; top: 38px; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* НОВЫЕ СТИЛИ ДЛЯ МОБИЛЬНОЙ НАВИГАЦИИ ВНИЗУ */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #161b22;
      border-top: 1px solid #30363d;
      display: flex;
      justify-content: space-around;
      padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #8b949e;
      font-size: 12px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      min-width: 60px;
      flex: 1;
      max-width: 90px;
      min-height: 44px;
    }

    .mobile-nav-item.active {
      color: #1f6feb;
      background: rgba(31, 111, 235, 0.1);
    }

    .mobile-nav-item img {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      filter: brightness(0.8);
    }

    .mobile-nav-item.active img {
      filter: brightness(1);
    }

    .request-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 25px;
    }

    .support-link-btn {
      background: #1f6feb;
      color: white;
      padding: 18px;
      border-radius: 8px;
      text-decoration: none;
      text-align: center;
      font-weight: 500;
      transition: background-color 0.2s;
      font-size: 16px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .support-link-btn:hover {
      background: #2b7ff5;
    }

    .cancel-withdraw-btn {
      background: #21262d;
      color: #c9d1d9;
      padding: 18px;
      border-radius: 8px;
      border: 1px solid #30363d;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
      font-size: 16px;
      min-height: 50px;
    }

    .cancel-withdraw-btn:hover {
      background: #30363d;
    }

    /* НОВЫЕ СТИЛИ ДЛЯ ИСПРАВЛЕНИЯ ПОЗИЦИЙ */
    .chart-header {
      padding: 15px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .company-title {
      font-weight: bold;
      font-size: 16px;
    }

    .chart-time {
      font-size: 14px;
      color: #8b949e;
      margin-top: 5px;
    }

    /* Кнопка открытия истории позиций на мобильной */
    .positions-toggle-btn {
      width: 100%;
      background: #161b22;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 15px;
      margin: 10px 0 0 0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
      min-height: 44px;
    }

    .positions-toggle-btn:hover {
      background: #21262d;
    }

    .positions-toggle-btn.expanded {
      border-radius: 8px 8px 0 0;
      border-bottom: none;
    }

    .positions-toggle-btn::after {
      content: "▼";
      font-size: 14px;
      transition: transform 0.3s;
    }

    .positions-toggle-btn.expanded::after {
      transform: rotate(180deg);
    }

    /* Контейнер для истории позиций в мобильной версии */
    .mobile-positions-container {
      display: none;
      max-height: 0;
      overflow: hidden;
      background: #0d1117;
      border: 1px solid #30363d;
      border-top: none;
      border-radius: 0 0 8px 8px;
      transition: max-height 0.3s ease;
      margin-bottom: 15px;
    }

    .mobile-positions-container.expanded {
      display: block;
      max-height: 400px;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    /* Контейнер для истории позиций в десктопной версии */
    .desktop-positions-container {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      margin-top: 15px;
      flex: 1;
      min-height: 200px;
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .positions-header {
      padding: 15px;
      background: #161b22;
      border-bottom: 1px solid #30363d;
      font-weight: bold;
      font-size: 16px;
      border-radius: 8px 8px 0 0;
    }

    .positions-content {
      flex: 1;
      overflow-y: auto;
    }

    .trade-main {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .empty-positions {
      padding: 30px;
      text-align: center;
      color: #8b949e;
      font-size: 16px;
    }

    @media (min-width: 768px) {
      .layout {
        flex-direction: row;
        height: calc(100vh - 60px);
      }
      
      .sidebar {
        flex-direction: column;
        justify-content: flex-start;
        width: 80px;
        height: calc(100vh - 60px);
        padding-top: 20px;
        gap: 30px;
        border-right: 1px solid #30363d;
        border-bottom: none;
        top: 60px;
      }
      
      .market-column {
        display: flex;
        width: 280px;
        height: calc(100vh - 60px);
      }
      
      .deal-row {
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
      }
      
      .deal-column {
        min-width: 180px;
      }
      
      .flex-space {
        flex-direction: row;
        gap: 4%;
        flex-wrap: wrap;
      }

      .trade-layout {
        display: flex;
        gap: 20px;
        height: 100%;
        min-height: 0;
      }

      .trade-main {
        flex: 2;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .trade-terminal {
        width: 350px;
        min-height: 0;
      }

      .chart-section {
        height: 45vh;
        min-height: 0;
        flex-shrink: 0;
      }

      /* Убираем мобильные элементы */
      .positions-toggle-btn,
      .mobile-positions-container {
        display: none;
      }

      .mobile-bottom-nav {
        display: none;
      }

      /* Десктопный контейнер для позиций */
      .desktop-positions-container {
        display: flex;
        margin-top: 10px;
      }
    }

    @media (max-width: 767px) {
      .main-container {
        flex-direction: column;
      }

      .market-column {
        display: none;
      }

      .layout {
        flex-direction: column;
        height: auto;
      }

      .header-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        padding: 10px max(15px, env(safe-area-inset-right));
        padding-left: max(15px, env(safe-area-inset-left));
      }

      .sidebar {
        display: none;
      }

      .page-content {
        margin-top: 60px;
        margin-bottom: calc(80px + env(safe-area-inset-bottom));
        padding: max(15px, env(safe-area-inset-left));
        padding-bottom: 20px;
        width: 100%;
        box-sizing: border-box;
      }

      .chart-section {
        height: 40vh;
        min-height: 250px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .chart-section iframe {
        min-height: 200px;
        flex: 1;
      }

      .trade-layout {
        display: flex;
        flex-direction: column;
        gap: 0;
        padding-bottom: 20px;
        width: 100%;
        box-sizing: border-box;
      }

      .trade-main {
        order: 1;
        width: 100%;
      }

      .trade-terminal {
        order: 2;
        margin-top: 20px;
        transition: transform 0.3s ease, margin-top 0.3s ease;
        width: 100%;
      }

      .trade-terminal.shifted {
        transform: translateY(120px);
        margin-top: 140px;
      }

      .desktop-positions-container {
        display: none;
      }

      .mobile-bottom-nav {
        display: flex;
      }

      .wallet-tabs {
        gap: 8px;
      }

      .wallet-tab {
        min-width: calc(50% - 4px);
        padding: 12px 8px;
        font-size: 14px;
      }

      .withdraw-tabs {
        gap: 8px;
      }

      .withdraw-tab {
        min-width: calc(50% - 4px);
        padding: 12px 8px;
        font-size: 14px;
      }

      .modal-btn {
        min-width: calc(50% - 8px);
      }
      
      .position-status {
        min-width: 100px;
      }
    }

    @media (max-width: 360px) {
      .trade-terminal.shifted {
        transform: translateY(100px);
        margin-top: 120px;
      }
      
      .mobile-nav-item {
        padding: 6px;
        font-size: 11px;
      }
      
      .mobile-nav-item img {
        width: 22px;
        height: 22px;
      }

      .wallet-tab {
        min-width: 100%;
      }

      .withdraw-tab {
        min-width: 100%;
      }

      .modal-btn {
        min-width: 100%;
      }
      
      .position-status {
        min-width: 80px;
      }
    }
  </style>
</head>
<body>
<!-- Форма входа -->
<div id="loginContainer" class="login-container">
  <div class="login-form">
    <h2>Вход в терминал</h2>
    <input type="text" id="loginEmail" placeholder="Логин" required>
    <input type="password" id="loginPassword" placeholder="Пароль" required>
    <button onclick="checkLogin()">Войти</button>
    <div id="loginError" class="login-error">Неверный логин или пароль</div>
    <div class="register-link">
      Нет аккаунта? <a href="https://tradegalardro.com/register/" target="_blank">Зарегистрироваться</a>
    </div>
  </div>
</div>

<!-- Основной контент (скрыт до входа) -->
<div id="mainContent" style="display: none;">
  <!-- Хедер с балансом -->
  <div class="header-bar">
    <div class="balance-info">
      <div class="balance-item">
        <span class="balance-label">Баланс:</span>
        <span class="balance-value" id="balanceValue">0.00 USDT</span>
      </div>
      <div class="balance-item">
        <span class="balance-label"></span>
        <span class="balance-value"> </span>
      </div>
      <div class="balance-item">
        <span class="balance-label"></span>
        <span class="balance-value positive" id="pnlValue"></span>
      </div>
    </div>
    <div class="user-menu">
      <span id="userLevel">Уровень: 1</span>
      <button class="menu-toggle" onclick="toggleMenu()">☰</button>
      <div class="dropdown-menu" id="dropdownMenu">
        <div class="menu-item" onclick="showPage('trade')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/home.png" alt="" />
          Торговля
        </div>
        <div class="menu-item" onclick="showPage('profile')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/user-male-circle.png" alt="" />
          Профиль
        </div>
        <div class="menu-item" onclick="showPage('deposit')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/money-transfer.png" alt="" />
          Депозит
        </div>
        <div class="menu-item" onclick="showPage('withdraw')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/export.png" alt="" />
          Вывод
        </div>
      </div>
    </div>
  </div>

  <!-- Основной контейнер -->
  <div class="main-container">
    <!-- Левая колонка с рыночными данными -->
    <div class="market-column">
      <!-- Список избранных активов -->
      <div class="watchlist-section">
        <div class="section-title">
          <span>Избранные активы</span>
        </div>
        <div id="watchlist">
          <!-- Активы будут добавлены через JavaScript -->
        </div>
      </div>

      <!-- Быстрые кнопки -->
      <div class="quick-buttons-section">
        <div class="section-title">Быстрый доступ</div>
        <div class="quick-buttons">
          <div class="quick-btn" onclick="selectAsset('BTC')">BTC/USDT</div>
          <div class="quick-btn" onclick="selectAsset('ETH')">ETH/USDT</div>
          <div class="quick-btn" onclick="selectAsset('AAPL')">AAPL</div>
          <div class="quick-btn" onclick="selectAsset('TSLA')">TSLA</div>
          <div class="quick-btn" onclick="selectAsset('NVDA')">NVDA</div>
          <div class="quick-btn" onclick="selectAsset('MSFT')">MSFT</div>
        </div>
      </div>

      <!-- Обзор портфеля -->
      <div class="portfolio-section">
        <div class="section-title">Обзор портфеля</div>
        <div class="portfolio-item">
          <span>Акции</span>
          <span>65%</span>
        </div>
        <div class="portfolio-bar">
          <div class="portfolio-fill" style="width: 65%; background: #1f6feb;"></div>
        </div>
        <div class="portfolio-item">
          <span>Крипто</span>
          <span>25%</span>
        </div>
        <div class="portfolio-bar">
          <div class="portfolio-fill" style="width: 25%; background: #16c784;"></div>
        </div>
        <div class="portfolio-item">
          <span>Фьючерсы</span>
          <span>10%</span>
        </div>
        <div class="portfolio-bar">
          <div class="portfolio-fill" style="width: 10%; background: #ea3943;"></div>
        </div>
      </div>

      <!-- Рыночные данные -->
      <div class="market-data-section">
        <div class="section-title">Рыночные данные</div>
        <div class="market-stats">
          <div class="stat-item">
            <div class="stat-value" id="btcDominance">42.8%</div>
            <div class="stat-label">Доминирование BTC</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="fearGreed">72</div>
            <div class="stat-label">Индекс страха</div>
          </div>
        </div>
        <div class="market-stats">
          <div class="stat-item">
            <div class="stat-value" id="totalMarketCap">2.11T</div>
            <div class="stat-label">Капитализация</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="volume24h">78.38B</div>
            <div class="stat-label">Объем 24ч</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Основной layout с меню и контентом -->
    <div class="layout">
      <!-- sidebar -->
      <div class="sidebar">
        <div class="sidebar-item active" onclick="showPage('trade')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/home.png" alt="" />
          <div>Торговля</div>
        </div>
        <div class="sidebar-item" onclick="showPage('profile')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/user-male-circle.png" alt="" />
          <div>Профиль</div>
        </div>
        <div class="sidebar-item" onclick="showPage('deposit')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/money-transfer.png" alt="" />
          <div>Депозит</div>
        </div>
        <div class="sidebar-item" onclick="showPage('withdraw')">
          <img src="https://img.icons8.com/ios-filled/24/ffffff/export.png" alt="" />
          <div>Вывод</div>
        </div>
      </div>

      <!-- Контент страниц -->
      
      <!-- Страница Торговля -->
      <div id="trade-page" class="page-content active">
        <div class="trade-layout">
          <div class="trade-main">
            <div class="chart-section">
              <div class="chart-header">
                <div class="company-title" id="companyTitle">Apple Inc</div>
                <div class="chart-time" id="currentTime">02:04:37 1024.83 | 02:04:33 – 03:04 (+0.01%)</div>
              </div>
              <iframe id="chartFrame" src="https://www.tradingview.com/widgetembed/?symbol=AAPL&interval=1&theme=dark"></iframe>
            </div>

            <!-- Кнопка для открытия истории позиций на мобильной -->
            <button class="positions-toggle-btn" id="positionsToggleBtn" onclick="toggleMobilePositions()">
              История позиций
            </button>
            
            <!-- Контейнер для истории позиций в мобильной версии -->
            <div id="mobilePositionsContainer" class="mobile-positions-container">
              <!-- Позиции будут добавляться здесь -->
              <div class="empty-positions">
                Нет открытых позиций
              </div>
            </div>

            <!-- Контейнер для истории позиций в десктопной версии -->
            <div class="desktop-positions-container">
              <div class="positions-header">История позиций</div>
              <div class="positions-content" id="desktopPositionsContainer">
                <!-- Позиции будут добавляться здесь -->
                <div class="empty-positions">
                  Нет открытых позиций
                </div>
              </div>
            </div>
          </div>
          
          <div class="trade-terminal" id="tradeTerminal">
            <div class="terminal-section">
              <div class="title">Фьючерсный терминал</div>
              
              <!-- Селектор компании в терминале -->
              <div class="selector-container">
                <button class="selector-button" onclick="toggleDropdown()">Текущая компания: <span id="selectedCompany">AAPL</span> ▼</button>
                <div id="dropdown" class="dropdown">
                  <input type="text" placeholder="Поиск..." oninput="filterCompanies(this.value)" />
                  <div id="companyList"></div>
                </div>
              </div>
              
              <div class="market-info">
                <div>
                  <span>Цена:</span>
                  <span id="currentPrice">${(Math.random() * 100 + 50).toFixed(2)} USD</span>
                </div>
                <div>
                  <span>24h Объем:</span>
                  <span id="dailyVolume">${(Math.random() * 5000 + 1000).toFixed(0)} BTC</span>
                </div>
                <div>
                  <span>24h Изменение:</span>
                  <span id="dailyChange" style="color: ${Math.random() > 0.5 ? '#16c784' : '#ea3943'}">
                    ${(Math.random() * 10 - 5).toFixed(2)}%
                  </span>
                </div>
              </div>
              <select id="orderType">
                <option>Лимитный</option>
                <option selected>Рыночный</option>
                <option>Триггер</option>
              </select>
              <div class="info-line">Режим активов: Один актив</div>
              <div class="info-line" id="availableBalanceInfo">Дост.: 0.0000 USDT</div>
              <input type="number" id="tradeSize" placeholder="Стоимость" value="0" min="0" step="10" />
              <select id="tradeCurrency">
                <option selected>USDT</option>
                <option>BTC</option>
              </select>
              <label for="leverage">Кредитное плечо:</label>
              <input type="range" id="leverage" min="1" max="100" value="20" oninput="updateLeverage(this.value)">
              <div class="leverage-display" id="leverage-value">20x</div>
              <div class="checkbox-group">
                <label><input type="checkbox" id="tpLongCheckbox" onchange="toggleTPSL(this, 'tp-sl-long')"> Лонг т-п/с-л</label>
                <label><input type="checkbox" id="tpShortCheckbox" onchange="toggleTPSL(this, 'tp-sl-short')"> Шорт т-п/с-л</label>
              </div>
              <div id="tp-sl-long" class="tp-sl">
                <input type="number" id="tpLong" placeholder="Лонг Take Profit (USDT)" value="110">
                <input type="number" id="slLong" placeholder="Лонг Stop Loss (USDT)" value="90">
              </div>
              <div id="tp-sl-short" class="tp-sl">
                <input type="number" id="tpShort" placeholder="Шорт Take Profit (USDT)" value="90">
                <input type="number" id="slShort" placeholder="Шорт Stop Loss (USDT)" value="110">
              </div>
              <div class="info-line">Ожид. цена ликвидации (лонг): —</div>
              <div class="info-line">Ожид. цена ликвидации (шорт): —</div>
              <div class="flex-space">
                <button class="btn btn-long" onclick="openPosition('Лонг')">Открыть лонг</button>
                <button class="btn btn-short" onclick="openPosition('Шорт')">Открыть шорт</button>
              </div>
              <div class="info-line">Уровень комиссии</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Страница Профиль -->
      <div id="profile-page" class="page-content">
        <div class="profile-container">
          <h2>Профиль пользователя</h2>
          
          <div class="user-id">
            <span class="label">ID пользователя:</span>
            <span class="value">J58syuYkou97dkdjk9yt</span>
          </div>
          
          <div class="user-email">
            <span class="label">Электронная почта:</span>
            <span class="value" id="userEmail">user@example.com</span>
          </div>
          
          <div class="profile-section">
            <div class="profile-column">
              <h3>Настройки профиля</h3>
              
              <div class="info-row">
                <span class="label">Двухфакторная аутентификация</span>
                <button class="profile-btn btn-secondary" onclick="enable2FA()">Включить</button>
              </div>
              
              <div class="kyc-message">
                <p><strong>Верификация KYC</strong></p>
                <p>Для полного доступа к функциям платформы требуется пройти верификацию личности.</p>
                <p>После подачи заявки проверка займет до 48 часов.</p>
              </div>
              
              <button class="profile-btn btn-kyc" onclick="showKycMessage()">Пройти верификацию KYC</button>
              
              <div class="info-row">
                <span class="label">Статус верификации:</span>
                <span class="status-badge status-pending">Частично верифицирован</span>
              </div>
            </div>
            
            <div class="profile-column">
              <h3>Личная информация</h3>
              <p style="color: #8b949e; margin-bottom: 15px; font-size: 14px;">Данные будут доступны после KYC верификации</p>
              
              <div class="info-row">
                <span class="label">Имя:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Фамилия:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Страна:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Город:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Адрес:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Почтовый индекс:</span>
                <span class="value">—</span>
              </div>
              
              <div class="info-row">
                <span class="label">Дата рождения:</span>
                <span class="value">—</span>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <div class="profile-column">
              <h3>Подтверждение личности</h3>
              
              <div class="file-upload">
                <label for="passport-front">Паспорт (главная страница)</label>
                <input type="file" id="passport-front" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="passport-selfie">Селфи с паспортом</label>
                <input type="file" id="passport-selfie" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="address-proof">Подтверждение адреса</label>
                <input type="file" id="address-proof" class="file-input" />
              </div>
            </div>
            
            <div class="profile-column">
              <h3>Платёжные данные</h3>
              
              <div class="file-upload">
                <label for="dod">DoD документ</label>
                <input type="file" id="dod" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="utility-bill">Utility bill</label>
                <input type="file" id="utility-bill" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="wire-transfer">Wire transfer swift</label>
                <input type="file" id="wire-transfer" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="card-front">Лицевая сторона карты</label>
                <input type="file" id="card-front" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="card-back">Обратная сторона карты</label>
                <input type="file" id="card-back" class="file-input" />
              </div>
              
              <div class="file-upload">
                <label for="payment-proof">Подтверждение платежа</label>
                <input type="file" id="payment-proof" class="file-input" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Страница Депозит -->
      <div id="deposit-page" class="page-content">
        <h1>Баланс</h1>
        
        <!-- Главный баланс как на реальной бирже -->
        <div class="total-balance">
          <div class="total-balance-label">Общий баланс</div>
          <div class="total-balance-amount" id="depositTotalBalance">0.00<span class="balance-currency">USDT</span></div>
        </div>

        <div class="available-balance">
          <div class="available-balance-label">Доступно для торговли</div>
          <div class="available-balance-amount" id="availableBalance">0.00 USDT</div>
        </div>
        
        <div class="balance-info-section">
          <div class="wallet-tabs">
            <div class="wallet-tab" data-wallet="btc">BTC</div>
            <div class="wallet-tab" data-wallet="eth">ETH</div>
            <div class="wallet-tab active" data-wallet="usdt-erc20">USDT ERC20</div>
            <div class="wallet-tab" data-wallet="usdt-trc20">USDT TRC20</div>
          </div>
          
          <!-- Кошельки -->
          <div id="btc-wallet" class="wallet-content">
            <div class="qr-code-container">
              <div class="qr-code">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=3FZbgi29pgTQ3KJJeuZPbQYJBJfZ4qJwYt" alt="BTC QR Code">
              </div>
              <div class="wallet-address">3FZbgi29pgTQ3KJJeuZPbQYJBJfZ4qJwYt</div>
              <div class="network-info">Bitcoin Network</div>
              <div class="wallet-buttons">
                <button class="wallet-btn copy-btn">Копировать адрес</button>
              </div>
            </div>
          </div>
          
          <div id="eth-wallet" class="wallet-content">
            <div class="qr-code-container">
              <div class="qr-code">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=0x71C7656EC7ab88b098defB751B7401B5f6d8976F" alt="ETH QR Code">
              </div>
              <div class="wallet-address">0x71C7656EC7ab88b098defB751B7401B5f6d8976F</div>
              <div class="network-info">Ethereum Network (ERC20)</div>
              <div class="wallet-buttons">
                <button class="wallet-btn copy-btn">Копировать адрес</button>
              </div>
            </div>
          </div>
          
          <div id="usdt-erc20-wallet" class="wallet-content active">
            <div class="qr-code-container">
              <div class="qr-code">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=TRWAUKg2yw1QRFh9TTsGvSJudyHACHzyJ3" alt="USDT ERC20 QR Code">
              </div>
              <div class="wallet-address">TRWAUKg2yw1QRFh9TTsGvSJudyHACHzyJ3</div>
              <div class="network-info">Ethereum Network (ERC20)</div>
              <div class="wallet-buttons">
                <button class="wallet-btn copy-btn">Копировать адрес</button>
              </div>
            </div>
          </div>
          
          <div id="usdt-trc20-wallet" class="wallet-content">
            <div class="qr-code-container">
              <div class="qr-code">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=TRWAUKg2yw1QRFh9TTsGvSJudyHACHzyJ3" alt="USDT TRC20 QR Code">
              </div>
              <div class="wallet-address">TRWAUKg2yw1QRFh9TTsGvSJudyHACHzyJ3</div>
              <div class="network-info">Tron Network (TRC20)</div>
              <div class="wallet-buttons">
                <button class="wallet-btn copy-btn">Копировать адрес</button>
              </div>
            </div>
          </div>
        </div>

        <div class="history-section">
          <h2>История транзакций</h2>
          <table class="history-table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Сумма</th>
                <th>Описание</th>
                <th>Счёт</th>
                <th>Тип</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody>
              <tr class="empty-history">
                <td colspan="6">Нет данных о транзакциях</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Страница Вывод -->
      <div id="withdraw-page" class="page-content">
        <h1>Вывод средств</h1>

        <!-- Главный баланс как на реальной бирже -->
        <div class="total-balance">
          <div class="total-balance-label">Доступно для вывода</div>
          <div class="total-balance-amount" id="withdrawTotalBalance">0.00<span class="balance-currency">USDT</span></div>
        </div>

        <div class="balance-display">
          <div class="balance-row">
            <span class="balance-label">Общий баланс</span>
            <span class="balance-amount" id="withdrawBalanceTotal">0.00 USDT</span>
          </div>
          <div class="balance-row">
            <span class="balance-label">Доступно для вывода</span>
            <span class="balance-amount" id="withdrawBalanceAvailable">0.00 USDT</span>
          </div>
          <div class="balance-row">
            <span class="balance-label">В ордерах</span>
            <span class="balance-amount">0.00 USDT</span>
          </div>
        </div>

        <div class="withdraw-form">
          <div class="withdraw-tabs">
            <div class="withdraw-tab active" onclick="switchWithdrawTab('bank')">Банковская карта</div>
            <div class="withdraw-tab" onclick="switchWithdrawTab('crypto')">Криптовалюта</div>
          </div>

          <div id="bank" class="form-section active">
            <div class="form-group">
              <label for="card-number">Номер карты</label>
              <input type="text" id="card-number" placeholder="0000 0000 0000 0000" />
            </div>
            <div class="form-group">
              <label for="card-holder">Имя владельца карты</label>
              <input type="text" id="card-holder" placeholder="IVAN IVANOV" />
            </div>
            <div class="form-group">
              <label for="withdraw-amount-bank">Сумма вывода (USDT)</label>
              <input type="text" id="withdraw-amount-bank" placeholder="0.00" />
            </div>
            <button class="submit-btn" onclick="showVipModal()">Вывести средства</button>
          </div>

          <div id="crypto" class="form-section">
            <div class="form-group">
              <label for="wallet-address">Адрес кошелька</label>
              <input type="text" id="wallet-address" placeholder="0x..." />
            </div>
            <div class="form-group">
              <label for="withdraw-amount-crypto">Сумма в USDT</label>
              <input type="text" id="withdraw-amount-crypto" placeholder="0.00" />
            </div>
            <button class="submit-btn" onclick="showCommissionModal()">Отправить криптовалюту</button>
          </div>
        </div>

        <div class="history-section">
          <h2>История транзакций</h2>
          <table class="history-table">
            <thead>
              <tr>
                <th>Дата</th>
                <th>Валюта</th>
                <th>Описание</th>
                <th>Сумма</th>
                <th>Статус</th>
              </tr>
            </thead>
            <tbody>
              <tr class="empty-history">
                <td colspan="5">Нет данных о транзакциях</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Мобильная навигация внизу -->
<div class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="mobile-nav-item active" onclick="showPage('trade')">
    <img src="https://img.icons8.com/ios-filled/24/ffffff/home.png" alt="Торговля" />
    <div>Торговля</div>
  </div>
  <div class="mobile-nav-item" onclick="showPage('profile')">
    <img src="https://img.icons8.com/ios-filled/24/ffffff/user-male-circle.png" alt="Профиль" />
    <div>Профиль</div>
  </div>
  <div class="mobile-nav-item" onclick="showPage('deposit')">
    <img src="https://img.icons8.com/ios-filled/24/ffffff/money-transfer.png" alt="Депозит" />
    <div>Депозит</div>
  </div>
  <div class="mobile-nav-item" onclick="showPage('withdraw')">
    <img src="https://img.icons8.com/ios-filled/24/ffffff/export.png" alt="Вывод" />
    <div>Вывод</div>
  </div>
</div>

<!-- Модальные окна для Вывода -->
<div class="modal-overlay" id="vipModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Доступ ограничен</h3>
      <button class="modal-close" onclick="closeVipModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-message">
        <p>Вывод на банковскую карту доступен только для VIP-пользователей.</p>
        <p>Для получения VIP-статуса обратитесь в службу поддержки.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" onclick="closeVipModal()">Закрыть</button>
      <button class="modal-btn modal-btn-confirm" onclick="closeVipModal()">Понятно</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="commissionModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Внимание: Высокие комиссии</h3>
      <button class="modal-close" onclick="closeCommissionModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="modal-message">
        <p>Информируем Вас о комиссиях при выводе средств.</p>
        
        <div class="commission-warning">
          <p><strong>Комиссия за вывод: 40%</strong></p>
          <p>Причина применения:</p>
          <ul class="commission-list">
            <li>• Отсутствием пройденной процедуры KYC-верификации;</li>
            <li>• Действием стартового тарифного плана (при депозите менее 1 000 USDT).</li>
          </ul>
        </div>

        <p><strong>Дополнительно:</strong> Биржа-получатель может удержать до 40% от суммы перевода согласно своим тарифам.</p>
        
        <p class="commission-total">Общие расходы на комиссию составят от 40% до 80% от запрашиваемой суммы.</p>
      </div>

      <div class="checkbox-container">
        <input type="checkbox" id="agreeCheckbox" onchange="toggleContinueButton()">
        <label for="agreeCheckbox" class="checkbox-label">
          Я соглашаюсь с тем что расходы на комиссию составят от 40% до 80% от суммы вывода
        </label>
      </div>

      <div id="supportMessage" class="support-message" style="display: none;">
        <p>Свяжитесь с поддержкой для подтверждения личности</p>
        <button class="modal-btn modal-btn-confirm" onclick="closeCommissionModal()">Закрыть</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" onclick="closeCommissionModal()">Отмена</button>
      <button class="modal-btn modal-btn-confirm" id="continueBtn" onclick="showSupportMessage()" disabled>Продолжить</button>
    </div>
  </div>
</div>

<!-- НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ТИПА REQUEST -->
<div class="modal-overlay" id="requestModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Запрос на вывод средств</h3>
      <button class="modal-close" onclick="closeRequestModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="success-checkmark">
        <div class="check-icon">
          <span class="icon-line line-tip"></span>
          <span class="icon-line line-long"></span>
          <div class="icon-circle"></div>
          <div class="icon-fix"></div>
        </div>
      </div>
      
      <div class="modal-message" style="text-align: center;">
        <p style="font-size: 20px; font-weight: bold; color: #16c784; margin-bottom: 20px;">✓ Запрос в обработке</p>
        <p>Для подтверждения вывода обратитесь в поддержку</p>
      </div>

      <div class="request-buttons">
        <a href="https://www.galardro.org/sapport" target="_blank" class="support-link-btn">
          Перейти в поддержку
        </a>
        <button class="cancel-withdraw-btn" onclick="closeRequestModal()">
          Отменить вывод
        </button>
      </div>
    </div>
  </div>
</div>

<!-- НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ТИПА NORMAL -->
<div class="modal-overlay" id="normalModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Запрос на вывод средств</h3>
      <button class="modal-close" onclick="closeNormalModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="success-checkmark">
        <div class="check-icon">
          <span class="icon-line line-tip"></span>
          <span class="icon-line line-long"></span>
          <div class="icon-circle"></div>
          <div class="icon-fix"></div>
        </div>
      </div>
      
      <div class="modal-message" style="text-align: center;">
        <p style="font-size: 20px; font-weight: bold; color: #16c784; margin-bottom: 20px;">✓ Запрос на вывод принят</p>
        <p>Средства будут зачислены в течение 24 часов</p>
      </div>

      <div class="normal-withdraw-info">
        <p><strong>Детали вывода:</strong></p>
        <div class="withdraw-details">
          <div class="detail-row">
            <span>Сумма вывода:</span>
            <span id="withdrawAmount">100.00 USDT</span>
          </div>
          <div class="detail-row">
            <span>Комиссия сети:</span>
            <span class="fee-amount" id="networkFee">1.00 USDT</span>
          </div>
          <div class="detail-row">
            <span>Вы получите:</span>
            <span class="receive-amount" id="receiveAmount">99.00 USDT</span>
          </div>
          <div class="detail-row">
            <span>Адрес кошелька:</span>
            <span id="walletAddressDisplay">0x742d35Cc6634C0532925a3b8D...</span>
          </div>
        </div>
      </div>

      <div class="countdown-timer" id="countdownTimer">
        Обработка: <span id="timerValue">24:00:00</span>
      </div>

      <div class="request-buttons">
        <button class="support-link-btn" onclick="closeNormalModal()">
          Закрыть
        </button>
        <button class="cancel-withdraw-btn" onclick="cancelNormalWithdraw()">
          Отменить вывод
        </button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Ошибка! Пожалуйста, попробуйте позже.</div>

<script>
// =============================================
// КОНФИГУРАЦИЯ SUPABASE (ТАБЛИЦА ДЛЯ СДЕЛОК)
// =============================================
const SUPABASE_CONFIG = {
  url: 'https://wkukgnkfbxgpvlraczeu.supabase.co',
  anonKey: 'sb_publishable_11WBFNEcbspv1yDyfxq7sQ_Nl51ew5i',
  usersTable: 'app_users',
  tradesTable: 'trades'
};

// =============================================
// ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
// =============================================
let supabase = null;
let currentUser = null;
let usersData = {};
let tradesChannel = null;
let positionsData = [];

// =============================================
// ИНИЦИАЛИЗАЦИЯ SUPABASE
// =============================================
try {
  supabase = window.supabase.createClient(
    SUPABASE_CONFIG.url,
    SUPABASE_CONFIG.anonKey
  );
  console.log('Supabase клиент инициализирован');
} catch (error) {
  console.error('Ошибка инициализации Supabase:', error);
  alert('Ошибка подключения к базе данных. Проверьте конфигурацию Supabase.');
}

// =============================================
// ОСНОВНЫЕ ФУНКЦИИ ДЛЯ СДЕЛОК В SUPABASE (ИСПРАВЛЕННЫЕ)
// =============================================

// 1. Открытие новой позиции в Supabase (ИСПРАВЛЕННАЯ - УДАЛЕН order_type)
async function openPositionInSupabase(type) {
  if (!currentUser || !supabase) {
    showToast('❌ Сначала войдите в систему');
    return null;
  }
  
  try {
    const company = document.getElementById("selectedCompany").textContent;
    const leverage = parseInt(document.getElementById("leverage").value);
    const tradeSizeInput = document.getElementById("tradeSize");
    const tradeSize = tradeSizeInput ? parseFloat(tradeSizeInput.value) : 0;
    
    // Проверка обязательных полей
    if (!tradeSize || isNaN(tradeSize) || tradeSize <= 0) {
      showToast('❌ Введите корректный размер позиции');
      return null;
    }
    
    if (!company) {
      showToast('❌ Выберите актив для торговли');
      return null;
    }
    
    // Получаем TP/SL значения
    let take_profit = null;
    let stop_loss = null;
    
    if (type === 'Лонг') {
      const tpLongCheckbox = document.getElementById("tpLongCheckbox");
      if (tpLongCheckbox && tpLongCheckbox.checked) {
        const tpVal = document.getElementById("tpLong").value;
        const slVal = document.getElementById("slLong").value;
        take_profit = tpVal ? parseFloat(tpVal) : null;
        stop_loss = slVal ? parseFloat(slVal) : null;
      }
    } else {
      const tpShortCheckbox = document.getElementById("tpShortCheckbox");
      if (tpShortCheckbox && tpShortCheckbox.checked) {
        const tpVal = document.getElementById("tpShort").value;
        const slVal = document.getElementById("slShort").value;
        take_profit = tpVal ? parseFloat(tpVal) : null;
        stop_loss = slVal ? parseFloat(slVal) : null;
      }
    }
    
    // Генерируем случайную цену входа (реалистичные значения)
    const getRandomPrice = (symbol) => {
      const prices = {
        'BTC': 50000 + Math.random() * 1000,
        'ETH': 3000 + Math.random() * 100,
        'AAPL': 150 + Math.random() * 5,
        'TSLA': 200 + Math.random() * 10,
        'NVDA': 500 + Math.random() * 20,
        'MSFT': 400 + Math.random() * 15
      };
      return prices[symbol] ? prices[symbol].toFixed(2) : (100 + Math.random() * 10).toFixed(2);
    };
    
    const entry_price = getRandomPrice(company);
    
    // Подготавливаем данные для вставки (БЕЗ order_type)
    const tradeData = {
      user_id: currentUser,
      symbol: company,
      symbol_full: company + '/USDT',
      direction: type,
      entry_price: entry_price,
      size: tradeSize,
      leverage: leverage,
      take_profit: take_profit,
      stop_loss: stop_loss,
      status: 'отработка',
      opened_at: new Date().toISOString(),
      created_at: new Date().toISOString()
    };
    
    console.log('Открытие позиции в Supabase:', JSON.stringify(tradeData, null, 2));
    
    // Вставляем запись в таблицу trades
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.tradesTable)
      .insert([tradeData])
      .select();
    
    if (error) {
      console.error('Ошибка открытия позиции в Supabase:', error);
      showToast('❌ Ошибка открытия позиции: ' + error.message);
      return null;
    }
    
    console.log('Позиция успешно открыта в Supabase:', data);
    
    // Обновляем баланс пользователя (вычитаем сумму сделки)
    if (usersData[currentUser]) {
      const currentBalance = parseFloat(usersData[currentUser].balance);
      if (!isNaN(currentBalance) && currentBalance >= tradeSize) {
        const newBalance = (currentBalance - tradeSize).toFixed(2);
        usersData[currentUser].balance = newBalance;
        
        // Обновляем баланс в Supabase
        await updateUserBalanceInSupabase(currentUser, newBalance);
        
        // Обновляем отображение баланса
        updateAllBalances();
      } else {
        showToast('⚠️ Недостаточно средств для открытия позиции');
        return null;
      }
    }
    
    return data[0];
    
  } catch (error) {
    console.error('Ошибка при открытии позиции:', error);
    showToast('❌ Ошибка открытия позиции: ' + error.message);
    return null;
  }
}

// 2. Загрузка позиций пользователя из Supabase
async function loadUserPositionsFromSupabase() {
  if (!currentUser || !supabase) {
    return [];
  }
  
  try {
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.tradesTable)
      .select('*')
      .eq('user_id', currentUser)
      .order('opened_at', { ascending: false });
    
    if (error) {
      console.error('Ошибка загрузки позиций из Supabase:', error);
      showToast('⚠️ Ошибка загрузки позиций');
      return [];
    }
    
    console.log(`Загружено ${data ? data.length : 0} позиций из Supabase`);
    return data || [];
    
  } catch (error) {
    console.error('Ошибка при загрузке позиций:', error);
    return [];
  }
}

// 3. Настройка Real-time подписки на позиции
function setupPositionsRealtime() {
  if (!supabase || !currentUser) {
    console.error('Supabase не инициализирован для real-time');
    return;
  }
  
  try {
    // Отписываемся от старой подписки, если есть
    if (tradesChannel) {
      supabase.removeChannel(tradesChannel);
    }
    
    // Создаем новую подписку на таблицу trades
    tradesChannel = supabase
      .channel(`user-trades-${currentUser}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: SUPABASE_CONFIG.tradesTable,
          filter: `user_id=eq.${currentUser}`
        },
        async (payload) => {
          console.log('Real-time обновление позиции:', payload);
          
          // Перезагружаем список позиций
          await loadAndDisplayPositions();
          
          // Если позиция закрыта - показываем уведомление
          if (payload.new && payload.new.status === 'закрыта' && 
              payload.old && payload.old.status === 'отработка') {
            const pnl = payload.new.pnl || 0;
            const pnlText = pnl > 0 ? `+${pnl.toFixed(2)}` : pnl.toFixed(2);
            showToast(`📊 Позиция закрыта! PnL: ${pnlText} USDT`);
          }
          
          // Показываем уведомление о новой позиции
          if (payload.eventType === 'INSERT') {
            showToast(`📈 Новая позиция ${payload.new.direction} на ${payload.new.symbol}`);
          }
        }
      )
      .subscribe((status) => {
        console.log('Real-time статус подписки на позиции:', status);
        if (status === 'SUBSCRIBED') {
          console.log('✅ Подписка на обновления позиций активирована');
        }
      });
      
    return tradesChannel;
    
  } catch (error) {
    console.error('Ошибка настройки real-time подписки на позиции:', error);
    return null;
  }
}

// 4. Загрузка и отображение позиций
async function loadAndDisplayPositions() {
  if (!currentUser) return;
  
  try {
    // Загружаем позиции из Supabase
    const positions = await loadUserPositionsFromSupabase();
    positionsData = positions;
    
    // Обновляем отображение в обоих контейнерах
    updatePositionsDisplay();
    
  } catch (error) {
    console.error('Ошибка загрузки позиций:', error);
  }
}

// =============================================
// ФУНКЦИИ УПРАВЛЕНИЯ ПОЛЬЗОВАТЕЛЯМИ
// =============================================

// Загрузка данных пользователя из Supabase
async function loadUsersDataFromSupabase() {
  if (!supabase) {
    console.error('Supabase не инициализирован');
    usersData = {};
    return usersData;
  }
  
  try {
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.usersTable)
      .select('*');
      
    if (error) {
      console.error('Ошибка загрузки из Supabase:', error);
      throw error;
    }
    
    usersData = {};
    if (data && data.length > 0) {
      data.forEach(user => {
        usersData[user.user_key] = {
          password: user.password,
          balance: user.balance ? parseFloat(user.balance).toFixed(2) : "0.00",
          level: user.level || 'Стандарт',
          withdrawType: user.withdraw_type || 'normal',
          email: user.email || `${user.user_key}@galardro.org`,
          id: user.id
        };
      });
    }
    
    console.log(`Загружено ${Object.keys(usersData).length} пользователей из Supabase`);
    return usersData;
    
  } catch (error) {
    console.error('Критическая ошибка загрузки из Supabase:', error);
    usersData = {};
    return usersData;
  }
}

// Прямой запрос пользователя из Supabase
async function getUserFromSupabase(userKey, password) {
  if (!supabase) {
    console.error('Supabase не инициализирован');
    return null;
  }
  
  try {
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.usersTable)
      .select('*')
      .eq('user_key', userKey)
      .eq('password', password)
      .single();
      
    if (error) {
      console.error('Ошибка запроса пользователя из Supabase:', error);
      return null;
    }
    
    return data;
    
  } catch (error) {
    console.error('Ошибка при запросе пользователя:', error);
    return null;
  }
}

// Обновление баланса пользователя в Supabase
async function updateUserBalanceInSupabase(userKey, newBalance) {
  if (!supabase || !userKey) {
    console.error('Нет подключения к Supabase или userKey');
    return false;
  }
  
  try {
    const { data, error } = await supabase
      .from(SUPABASE_CONFIG.usersTable)
      .update({ 
        balance: parseFloat(newBalance),
        updated_at: new Date().toISOString()
      })
      .eq('user_key', userKey)
      .select();
      
    if (error) {
      console.error('Ошибка обновления баланса в Supabase:', error);
      return false;
    }
    
    console.log('Баланс обновлен в Supabase для пользователя', userKey, 'новый баланс:', newBalance);
    return true;
    
  } catch (error) {
    console.error('Ошибка при обновлении баланса:', error);
    return false;
  }
}

// =============================================
// ОСНОВНЫЕ ФУНКЦИИ ПРИЛОЖЕНИЯ
// =============================================

// Загружаем данные при старте
window.addEventListener('DOMContentLoaded', async function() {
  if (!supabase) {
    console.error('Supabase не инициализирован');
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContent').style.display = 'none';
    return;
  }
  
  // Загружаем данные пользователей из Supabase
  await loadUsersDataFromSupabase();
  
  // Проверяем авторизацию
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
  const savedUser = localStorage.getItem('currentUser');
  
  if (isLoggedIn && savedUser && usersData[savedUser]) {
    currentUser = savedUser;
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    updateUserData();
    updateAllBalances();
    initWatchlist();
    updateCurrentTime();
    initCompanyList();
    
    // Загружаем позиции из Supabase
    await loadAndDisplayPositions();
    
    // Настраиваем real-time подписку на позиции
    setupPositionsRealtime();
    
    showToast('✅ Сессия восстановлена');
  } else {
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContent').style.display = 'none';
  }
});

// =============================================
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// =============================================

// Функция для переключения меню
function toggleMenu() {
  const dropdownMenu = document.getElementById('dropdownMenu');
  dropdownMenu.classList.toggle('active');
}

// Закрытие меню при клике вне его
document.addEventListener('click', function(event) {
  const dropdownMenu = document.getElementById('dropdownMenu');
  const menuToggle = document.querySelector('.menu-toggle');
  
  if (!dropdownMenu.contains(event.target) && !menuToggle.contains(event.target)) {
    dropdownMenu.classList.remove('active');
  }
});

// Функция для переключения истории позиций на мобильной
function toggleMobilePositions() {
  const positionsContainer = document.getElementById('mobilePositionsContainer');
  const toggleBtn = document.getElementById('positionsToggleBtn');
  const tradeTerminal = document.getElementById('tradeTerminal');
  
  positionsContainer.classList.toggle('expanded');
  toggleBtn.classList.toggle('expanded');
  
  // На мобильных устройствах сдвигаем терминал вниз
  if (window.innerWidth <= 767) {
    tradeTerminal.classList.toggle('shifted');
  }
}

// Система навигации
function showPage(page) {
  document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
  
  document.getElementById(`${page}-page`).classList.add('active');
  
  // Закрываем меню
  document.getElementById('dropdownMenu').classList.remove('active');
  
  // Активируем соответствующий элемент в навигации
  if (window.innerWidth > 767) {
    // Десктопная навигация
    if (event && event.currentTarget) {
      event.currentTarget.classList.add('active');
    }
  } else {
    // Мобильная навигация
    const mobileItems = document.querySelectorAll('.mobile-nav-item');
    const pages = ['trade', 'profile', 'deposit', 'withdraw'];
    mobileItems.forEach((item, index) => {
      if (pages[index] === page) {
        item.classList.add('active');
      }
    });
  }
  
  // Обновляем балансы при переключении страниц
  if (currentUser) {
    updateAllBalances();
  }
  
  // Если показываем страницу торговли, обновляем позиции
  if (page === 'trade') {
    updatePositionsDisplay();
  }
}

// Обновление всех балансов на страницах
function updateAllBalances() {
  if (!currentUser || !usersData[currentUser]) {
    console.log('Нет текущего пользователя для обновления балансов');
    return;
  }
  
  const user = usersData[currentUser];
  const balance = user.balance || "0.00";
  
  console.log('Обновление балансов для пользователя:', currentUser, 'баланс:', balance);
  
  // Хедер
  document.getElementById('balanceValue').textContent = balance + ' USDT';
  
  // Терминал
  const availableBalanceInfo = document.getElementById('availableBalanceInfo');
  if (availableBalanceInfo) {
    availableBalanceInfo.textContent = `Дост.: ${balance} USDT`;
  }
  
  // Депозит страница
  const depositTotalBalance = document.getElementById('depositTotalBalance');
  if (depositTotalBalance) {
    depositTotalBalance.innerHTML = balance + '<span class="balance-currency">USDT</span>';
  }
  
  const availableBalance = document.getElementById('availableBalance');
  if (availableBalance) {
    availableBalance.textContent = balance + ' USDT';
  }
  
  // Вывод страница
  const withdrawTotalBalance = document.getElementById('withdrawTotalBalance');
  if (withdrawTotalBalance) {
    withdrawTotalBalance.innerHTML = balance + '<span class="balance-currency">USDT</span>';
  }
  
  const withdrawBalanceTotal = document.getElementById('withdrawBalanceTotal');
  if (withdrawBalanceTotal) {
    withdrawBalanceTotal.textContent = balance + ' USDT';
  }
  
  const withdrawBalanceAvailable = document.getElementById('withdrawBalanceAvailable');
  if (withdrawBalanceAvailable) {
    withdrawBalanceAvailable.textContent = balance + ' USDT';
  }
}

// Проверка входа
async function checkLogin() {
  if (!supabase) {
    alert('Ошибка подключения к базе данных');
    return;
  }
  
  const login = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errorElement = document.getElementById('loginError');
  
  if (!login || !password) {
    errorElement.style.display = 'block';
    return;
  }
  
  try {
    // Прямой запрос к Supabase для проверки логина
    const userData = await getUserFromSupabase(login, password);
    
    if (userData) {
      // Логин успешен
      currentUser = login;
      
      // Обновляем локальный кэш
      usersData[login] = {
        password: userData.password,
        balance: userData.balance ? parseFloat(userData.balance).toFixed(2) : "0.00",
        level: userData.level || 'Стандарт',
        withdrawType: userData.withdraw_type || 'normal',
        email: userData.email || `${login}@galardro.org`,
        id: userData.id
      };
      
      // Сохраняем в localStorage
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('currentUser', login);
      
      // Обновляем UI
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      updateUserData();
      updateAllBalances();
      initWatchlist();
      updateCurrentTime();
      initCompanyList();
      
      // Загружаем позиции из Supabase
      await loadAndDisplayPositions();
      
      // Настраиваем real-time подписку
      setupPositionsRealtime();
      
      // Скрываем ошибку
      errorElement.style.display = 'none';
      
      console.log('Пользователь успешно вошел:', login);
      showToast('✅ Успешный вход!');
    } else {
      // Пользователь не найден или неверный пароль
      errorElement.style.display = 'block';
      showToast('❌ Неверный логин или пароль');
    }
  } catch (error) {
    console.error('Ошибка при входе:', error);
    errorElement.style.display = 'block';
    showToast('❌ Ошибка входа');
  }
}

// Функция выхода
function logout() {
  if (confirm('Вы уверены, что хотите выйти?')) {
    // Отписываемся от real-time
    if (tradesChannel) {
      supabase.removeChannel(tradesChannel);
      tradesChannel = null;
    }
    
    // Очищаем данные
    currentUser = null;
    positionsData = [];
    
    // Очищаем localStorage
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('currentUser');
    
    // Обновляем UI
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'flex';
    
    // Очищаем поля ввода
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    
    showToast('Вы вышли из системы');
  }
}

// Обновление отображения позиций
function updatePositionsDisplay() {
  const mobileContainer = document.getElementById('mobilePositionsContainer');
  const desktopContainer = document.getElementById('desktopPositionsContainer');
  
  // Обновляем оба контейнера
  updatePositionsContainer(mobileContainer);
  updatePositionsContainer(desktopContainer);
}

// Обновление контейнера с позициями
function updatePositionsContainer(container) {
  if (!container) return;
  
  // Очищаем контейнер
  container.innerHTML = '';
  
  if (positionsData.length === 0) {
    container.innerHTML = '<div class="empty-positions">Нет открытых позиций</div>';
    return;
  }
  
  // Добавляем позиции
  positionsData.forEach(position => {
    const positionElement = createPositionElement(position);
    container.appendChild(positionElement);
  });
}

// Создание элемента позиции
function createPositionElement(position) {
  const directionColor = position.direction === "Лонг" ? "#16c784" : "#ea3943";
  const dealBlock = document.createElement("div");
  dealBlock.className = "deal-block";
  
  // Определяем статус
  const statusClass = position.status === 'отработка' ? 'status-processing' : 'status-closed';
  const statusText = position.status === 'отработка' ? 'Отработка 🔄' : 'Закрыта полностью ✅';
  
  // Определяем PnL
  const pnl = position.pnl || 0;
  const pnlClass = pnl > 0 ? 'pnl-positive' : (pnl < 0 ? 'pnl-negative' : '');
  const pnlText = pnl ? `${pnl > 0 ? '+' : ''}${pnl.toFixed(2)}` : '—';
  const pnlDisplay = pnl ? `${pnlText} USDT` : '—';
  
  // Форматируем дату
  const timeOpened = new Date(position.opened_at).toLocaleTimeString('ru-RU', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // TP/SL информация
  const tpInfo = position.take_profit ? `TP: ${position.take_profit}` : 'TP: —';
  const slInfo = position.stop_loss ? `SL: ${position.stop_loss}` : 'SL: —';
  
  dealBlock.innerHTML = `
    <div class="deal-info">
      <div><strong>${position.symbol}USDT</strong> 
        <span style="color:${directionColor}">${position.direction}</span> 
        <span>Кросс</span> 
        <span>${position.leverage}x</span>
      </div>
      <div class="deal-row">
        <div class="deal-column">
          <div>Ср. цена открытия: <span>${position.entry_price}</span> USDT</div>
        </div>
        <div class="deal-column">
          <div>Всего открыто: <span>${position.size}</span> USDT</div>
        </div>
        <div class="deal-column">
          <div>П/У позиции: <span class="profit">—</span> USDT</div>
          <div>Реализованная П/У: <span class="realized">${pnlDisplay}</span> USDT</div>
        </div>
        <div class="deal-column">
          <div>${tpInfo}</div>
          <div>${slInfo}</div>
          <div>Время открытия: ${timeOpened}</div>
        </div>
      </div>
    </div>
    <div class="position-status">
      <div class="status-badge ${statusClass}">${statusText}</div>
      <div class="position-pnl ${pnlClass}">${pnlDisplay}</div>
    </div>
  `;
  
  return dealBlock;
}

// =============================================
// ГЛАВНАЯ ФУНКЦИЯ ОТКРЫТИЯ ПОЗИЦИИ (ИСПРАВЛЕННАЯ)
// =============================================
async function openPosition(type) {
  if (!currentUser) {
    showToast('Сначала войдите в систему');
    return;
  }
  
  // Получаем данные из формы
  const tradeSizeInput = document.getElementById('tradeSize');
  const tradeSize = tradeSizeInput ? tradeSizeInput.value : '0';
  
  if (!tradeSize || parseFloat(tradeSize) <= 0) {
    showToast('Введите корректный размер позиции');
    return;
  }
  
  // Проверяем баланс
  const userBalance = parseFloat(usersData[currentUser]?.balance || 0);
  const positionSize = parseFloat(tradeSize);
  
  if (userBalance < positionSize) {
    showToast('❌ Недостаточно средств для открытия позиции');
    return;
  }
  
  // Открываем позицию в Supabase
  const position = await openPositionInSupabase(type);
  
  if (position) {
    // Показываем уведомление
    showToast(`✅ Позиция ${type} на ${position.symbol} открыта! Размер: ${position.size} USDT`);
    
    // Обновляем отображение позиций (real-time сделает это автоматически)
    await loadAndDisplayPositions();
  }
}

// =============================================
// ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ
// =============================================

// Инициализация списка компаний для выпадающего меню
const companies = [
  "AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "SHEL", "NVDA", "META",
  "NFLX", "INTC", "AMD", "BABA", "ORCL", "CRM", "ADBE", "QCOM", "UBER",
  "PYPL", "T", "DIS", "KO", "PEP", "WMT", "MCD", "XOM", "CVX", "BA"
];

function initCompanyList() {
  const companyList = document.getElementById('companyList');
  if (!companyList) return;
  
  companyList.innerHTML = '';
  
  companies.forEach(company => {
    const div = document.createElement('div');
    div.textContent = company;
    div.onclick = () => selectAsset(company);
    companyList.appendChild(div);
  });
}

// Обновление данных пользователя
function updateUserData() {
  if (!currentUser || !usersData[currentUser]) return;
  
  const user = usersData[currentUser];
  const levelElement = document.getElementById('userLevel');
  const emailElement = document.getElementById('userEmail');
  
  // Обновляем уровень
  if (levelElement) {
    levelElement.textContent = `Уровень: ${user.level}`;
  }
  
  // Обновляем почту
  if (emailElement) {
    emailElement.textContent = user.email || `${currentUser}@galardro.org`;
  }
}

// Обновление текущего времени
function updateCurrentTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
  const dateString = now.toLocaleDateString('ru-RU');
  
  const currentTimeElement = document.getElementById('currentTime');
  if (currentTimeElement) {
    currentTimeElement.textContent = `${timeString} ${dateString} | ${timeString} – ${timeString} (+0.01%)`;
  }
  
  setTimeout(updateCurrentTime, 1000);
}

// Инициализация списка избранных активов
function initWatchlist() {
  const watchlist = [
    { symbol: 'BTC/USDT', price: 89962.22, change: 2.99 },
    { symbol: 'ETH/USDT', price: 9917.45, change: 1.15 },
    { symbol: 'AAPL', price: 790.12, change: 0.97 },
    { symbol: 'TSLA', price: 802.39, change: 3.86 },
    { symbol: 'NVDA', price: 4929.91, change: 1.00 },
    { symbol: 'MSFT', price: 739.59, change: 1.31 }
  ];
  
  const watchlistContainer = document.getElementById('watchlist');
  if (!watchlistContainer) return;
  
  watchlistContainer.innerHTML = '';
  
  watchlist.forEach(asset => {
    const item = document.createElement('div');
    item.className = 'watchlist-item';
    item.onclick = () => selectAsset(asset.symbol.split('/')[0]);
    
    const changeClass = asset.change >= 0 ? 'positive' : 'negative';
    const changeSign = asset.change >= 0 ? '+' : '';
    
    item.innerHTML = `
      <div class="asset-name">${asset.symbol}</div>
      <div class="asset-price">${asset.price.toLocaleString()}</div>
      <div class="asset-change ${changeClass}">${changeSign}${asset.change}%</div>
    `;
    
    watchlistContainer.appendChild(item);
  });
  
  updateWatchlistPrices();
}

// Обновление цен в списке избранных активов
function updateWatchlistPrices() {
  const items = document.querySelectorAll('.watchlist-item');
  
  items.forEach(item => {
    const priceElement = item.querySelector('.asset-price');
    const changeElement = item.querySelector('.asset-change');
    
    if (priceElement && changeElement) {
      const currentPrice = parseFloat(priceElement.textContent.replace(/,/g, ''));
      const currentChange = parseFloat(changeElement.textContent);
      
      const priceChange = (Math.random() * 10 - 5) / 100;
      const newPrice = currentPrice * (1 + priceChange / 100);
      const newChange = currentChange + priceChange;
      
      priceElement.textContent = newPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      changeElement.textContent = (newChange >= 0 ? '+' : '') + newChange.toFixed(2) + '%';
      changeElement.className = `asset-change ${newChange >= 0 ? 'positive' : 'negative'}`;
    }
  });
  
  updateMarketData();
  setTimeout(updateWatchlistPrices, 3000);
}

// Обновление рыночных данных
function updateMarketData() {
  const priceElement = document.getElementById('currentPrice');
  const volumeElement = document.getElementById('dailyVolume');
  const changeElement = document.getElementById('dailyChange');
  
  if (priceElement) {
    const currentPrice = parseFloat(priceElement.textContent.split(' ')[0]) || 100;
    const newPrice = (currentPrice + (Math.random() * 0.5 - 0.25)).toFixed(2);
    priceElement.textContent = `${newPrice} USD`;
    priceElement.style.color = newPrice > currentPrice ? '#16c784' : '#ea3943';
    setTimeout(() => priceElement.style.color = '#c9d1d9', 500);
  }
  
  if (volumeElement) {
    const currentVolume = parseFloat(volumeElement.textContent) || 1000;
    const newVolume = (currentVolume + (Math.random() * 100 - 50)).toFixed(0);
    volumeElement.textContent = `${Math.abs(newVolume)} BTC`;
  }
  
  if (changeElement) {
    const currentChange = parseFloat(changeElement.textContent) || 0;
    const newChange = (currentChange + (Math.random() * 0.5 - 0.25)).toFixed(2);
    changeElement.textContent = `${newChange}%`;
    changeElement.style.color = newChange >= 0 ? '#16c784' : '#ea3943';
  }
}

// Выбор актива
function selectAsset(symbol) {
  document.getElementById("selectedCompany").textContent = symbol;
  document.getElementById("companyTitle").textContent = symbol;
  
  const overrides = {
    "BTC": "BINANCE:BTCUSDT",
    "ETH": "BINANCE:ETHUSDT",
    "AAPL": "NASDAQ:AAPL",
    "MSFT": "NASDAQ:MSFT",
    "GOOGL": "NASDAQ:GOOGL",
    "AMZN": "NASDAQ:AMZN",
    "TSLA": "NASDAQ:TSLA",
    "SHEL": "NYSE:SHEL",
    "NVDA": "NASDAQ:NVDA",
    "META": "NASDAQ:META",
    "NFLX": "NASDAQ:NFLX",
    "INTC": "NASDAQ:INTC",
    "AMD": "NASDAQ:AMD",
    "BABA": "NYSE:BABA",
    "ORCL": "NYSE:ORCL",
    "CRM": "NYSE:CRM",
    "ADBE": "NASDAQ:ADBE",
    "QCOM": "NASDAQ:QCOM",
    "UBER": "NYSE:UBER",
    "PYPL": "NASDAQ:PYPL",
    "T": "NYSE:T",
    "DIS": "NYSE:DIS",
    "KO": "NYSE:KO",
    "PEP": "NASDAQ:PEP",
    "WMT": "NYSE:WMT",
    "MCD": "NYSE:MCD",
    "XOM": "NYSE:XOM",
    "CVX": "NYSE:CVX",
    "BA": "NYSE:BA"
  };
  
  const tvSymbol = overrides[symbol] || `NASDAQ:${symbol}`;
  
  // Обновляем заголовок графика
  document.getElementById("companyTitle").textContent = symbol;
  
  // Обновляем iframe с графиком
  const chartFrame = document.getElementById("chartFrame");
  chartFrame.src = `https://www.tradingview.com/widgetembed/?symbol=${tvSymbol}&interval=1&theme=dark`;
  
  // Обновляем рыночные данные
  updateMarketData();
  
  // Закрываем выпадающее меню
  document.getElementById("dropdown").style.display = "none";
}

function updateLeverage(val) {
  document.getElementById("leverage-value").textContent = val + "x";
}

function toggleDropdown() {
  const dropdown = document.getElementById("dropdown");
  dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
  if (dropdown.style.display === "block") {
    filterCompanies("");
    document.getElementById("dropdown").querySelector("input").focus();
  }
}

function filterCompanies(search = "") {
  const filtered = companies.filter(c => c.toLowerCase().includes(search.toLowerCase()));
  const companyList = document.getElementById("companyList");
  companyList.innerHTML = "";
  filtered.forEach(company => {
    const div = document.createElement("div");
    div.textContent = company;
    div.onclick = () => selectAsset(company);
    companyList.appendChild(div);
  });
}

document.addEventListener("click", function(e) {
  if (!e.target.closest(".selector-container")) {
    document.getElementById("dropdown").style.display = "none";
  }
});

function toggleTPSL(checkbox, targetId) {
  const target = document.getElementById(targetId);
  target.style.display = checkbox.checked ? 'block' : 'none';
}

// Функции для страницы Профиль
function showKycMessage() {
  alert("В связи с безопасностью KYC верификацию можно будет пройти только после 48 дней после регистрации\n\nДо прохождения верификации вам будут доступны все базовые функции биржи\n\nНекоторые функции будет скрыты на сайте, но будут поступать вам на почту\n\nПриятной торговли");
}

function changePassword() {
  alert("Функция изменения пароля временно недоступна. Для смены пароля обратитесь в службу поддержки.");
}

function enable2FA() {
  alert("Двухфакторная аутентификация будет доступна после прохождения KYC верификации.");
}

// Функции для страницы Депозит
document.addEventListener('DOMContentLoaded', function() {
  const walletTabs = document.querySelectorAll('.wallet-tab');
  walletTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      walletTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      document.querySelectorAll('.wallet-content').forEach(content => {
        content.classList.remove('active');
      });
      
      const walletId = this.getAttribute('data-wallet');
      const walletElement = document.getElementById(`${walletId}-wallet`);
      if (walletElement) {
        walletElement.classList.add('active');
      }
    });
  });

  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const container = this.closest('.qr-code-container');
      if (!container) return;
      
      const addressElement = container.querySelector('.wallet-address');
      if (!addressElement) return;
      
      const address = addressElement.textContent;
      navigator.clipboard.writeText(address)
        .then(() => {
          const originalText = this.textContent;
          this.textContent = '✓ Скопировано';
          this.classList.add('copied');
          
          setTimeout(() => {
            this.textContent = originalText;
            this.classList.remove('copied');
          }, 2000);
        })
        .catch(err => {
          console.error('Ошибка копирования: ', err);
          const textArea = document.createElement('textarea');
          textArea.value = address;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            const originalText = this.textContent;
            this.textContent = '✓ Скопировано';
            this.classList.add('copied');
            
            setTimeout(() => {
              this.textContent = originalText;
              this.classList.remove('copied');
            }, 2000);
          } catch (fallbackErr) {
            alert('Не удалось скопировать адрес. Скопируйте вручную.');
          }
          document.body.removeChild(textArea);
        });
    });
  });
});

// Функции для страницы Вывод
function switchWithdrawTab(type) {
  document.querySelectorAll('.withdraw-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.form-section').forEach(sec => sec.classList.remove('active'));

  const tabElement = document.querySelector(`.withdraw-tab[onclick*="${type}"]`);
  const sectionElement = document.getElementById(type);
  
  if (tabElement) tabElement.classList.add('active');
  if (sectionElement) sectionElement.classList.add('active');
}

function showVipModal() {
  document.getElementById('vipModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeVipModal() {
  document.getElementById('vipModal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

// Обработка вывода средств
function showCommissionModal() {
  if (!currentUser || !usersData[currentUser]) {
    alert('Сначала войдите в систему');
    return;
  }
  
  const user = usersData[currentUser];
  
  // Проверяем тип вывода пользователя
  if (user.withdrawType === "normal") {
    showNormalModal();        // 👈 НОВЫЙ ТИП 3
  } else if (user.withdrawType === "request") {
    showRequestModal();       // 👈 ТИП 2
  } else {
    showCommissionModalOld(); // 👈 ТИП 1
  }
}

// СТАРАЯ ФУНКЦИЯ КОМИССИИ
function showCommissionModalOld() {
  const modal = document.getElementById('commissionModal');
  if (!modal) return;
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  const checkbox = document.getElementById('agreeCheckbox');
  const continueBtn = document.getElementById('continueBtn');
  const supportMessage = document.getElementById('supportMessage');
  
  if (checkbox) checkbox.checked = false;
  if (continueBtn) continueBtn.disabled = true;
  if (supportMessage) supportMessage.style.display = 'none';
  
  const checkboxContainer = document.querySelector('.checkbox-container');
  const modalFooter = document.querySelector('.modal-footer');
  
  if (checkboxContainer) checkboxContainer.style.display = 'flex';
  if (modalFooter) modalFooter.style.display = 'flex';
}

// ФУНКЦИЯ ДЛЯ ТИПА REQUEST
function showRequestModal() {
  const modal = document.getElementById('requestModal');
  if (!modal) return;
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// НОВАЯ ФУНКЦИЯ ДЛЯ ТИПА NORMAL
function showNormalModal() {
  // Получаем данные из формы
  const amountInput = document.getElementById('withdraw-amount-crypto');
  const walletInput = document.getElementById('wallet-address');
  
  const amount = amountInput ? amountInput.value || '100.00' : '100.00';
  const walletAddress = walletInput ? walletInput.value || '0x742d35Cc6634C0532925a3b8D...' : '0x742d35Cc6634C0532925a3b8D...';
  
  // Рассчитываем комиссию (1% для нормального вывода)
  const networkFee = (parseFloat(amount) * 0.01).toFixed(2);
  const receiveAmount = (parseFloat(amount) - parseFloat(networkFee)).toFixed(2);
  
  // Обновляем данные в модальном окне
  const withdrawAmount = document.getElementById('withdrawAmount');
  const networkFeeElement = document.getElementById('networkFee');
  const receiveAmountElement = document.getElementById('receiveAmount');
  const walletAddressDisplay = document.getElementById('walletAddressDisplay');
  
  if (withdrawAmount) withdrawAmount.textContent = amount + ' USDT';
  if (networkFeeElement) networkFeeElement.textContent = networkFee + ' USDT';
  if (receiveAmountElement) receiveAmountElement.textContent = receiveAmount + ' USDT';
  if (walletAddressDisplay) walletAddressDisplay.textContent = walletAddress;
  
  // Запускаем таймер обратного отсчета
  startCountdownTimer();
  
  // Показываем модальное окно
  const modal = document.getElementById('normalModal');
  if (!modal) return;
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Функция для запуска таймера обратного отсчета
let countdownInterval = null;
function startCountdownTimer() {
  let timeLeft = 24 * 60 * 60; // 24 часа в секундах
  
  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  
  const timerElement = document.getElementById('timerValue');
  if (!timerElement) return;
  
  countdownInterval = setInterval(() => {
    timeLeft--;
    
    if (timeLeft <= 0) {
      clearInterval(countdownInterval);
      timerElement.textContent = 'Завершено';
      timerElement.style.color = '#16c784';
      return;
    }
    
    const hours = Math.floor(timeLeft / 3600);
    const minutes = Math.floor((timeLeft % 3600) / 60);
    const seconds = timeLeft % 60;
    
    timerElement.textContent = 
      `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

// Функция отмены обычного вывода
function cancelNormalWithdraw() {
  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  closeNormalModal();
  showToast('Вывод отменен');
}

function closeNormalModal() {
  const modal = document.getElementById('normalModal');
  if (!modal) return;
  
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

function closeRequestModal() {
  const modal = document.getElementById('requestModal');
  if (!modal) return;
  
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

function closeCommissionModal() {
  const modal = document.getElementById('commissionModal');
  if (!modal) return;
  
  modal.classList.remove('active');
  document.body.style.overflow = 'auto';
}

function toggleContinueButton() {
  const checkbox = document.getElementById('agreeCheckbox');
  const continueBtn = document.getElementById('continueBtn');
  
  if (checkbox && continueBtn) {
    continueBtn.disabled = !checkbox.checked;
  }
}

function showSupportMessage() {
  const checkboxContainer = document.querySelector('.checkbox-container');
  const modalFooter = document.querySelector('.modal-footer');
  const supportMessage = document.getElementById('supportMessage');
  
  if (checkboxContainer) checkboxContainer.style.display = 'none';
  if (modalFooter) modalFooter.style.display = 'none';
  if (supportMessage) supportMessage.style.display = 'block';
}

function showToast(message) {
  const toast = document.getElementById("toast");
  if (!toast) return;
  
  toast.textContent = message;
  toast.style.display = "block";
  
  // Меняем цвет в зависимости от типа сообщения
  if (message.includes('✅') || message.includes('✓') || message.includes('Успешный')) {
    toast.style.backgroundColor = '#16c784';
  } else if (message.includes('❌') || message.includes('Ошибка') || message.includes('Неверный')) {
    toast.style.backgroundColor = '#f85149';
  } else {
    toast.style.backgroundColor = '#1f6feb';
  }
  
  setTimeout(() => {
    toast.style.display = "none";
  }, 4000);
}

// Закрытие модальных окон при клике вне окна
document.addEventListener('click', function(event) {
  const vipModal = document.getElementById('vipModal');
  const commissionModal = document.getElementById('commissionModal');
  const requestModal = document.getElementById('requestModal');
  const normalModal = document.getElementById('normalModal');
  
  if (event.target === vipModal) {
    closeVipModal();
  }
  if (event.target === commissionModal) {
    closeCommissionModal();
  }
  if (event.target === requestModal) {
    closeRequestModal();
  }
  if (event.target === normalModal) {
    closeNormalModal();
  }
});

// Закрытие модальных окон при нажатии Escape
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeVipModal();
    closeCommissionModal();
    closeRequestModal();
    closeNormalModal();
  }
});

// Добавляем кнопку выхода в меню
document.addEventListener('DOMContentLoaded', function() {
  const dropdownMenu = document.getElementById('dropdownMenu');
  if (dropdownMenu) {
    const logoutItem = document.createElement('div');
    logoutItem.className = 'menu-item';
    logoutItem.innerHTML = `
      <img src="https://img.icons8.com/ios-filled/24/ffffff/exit.png" alt="" />
      Выйти
    `;
    logoutItem.onclick = logout;
    dropdownMenu.appendChild(logoutItem);
  }
});
</script>
</body>
</html>
