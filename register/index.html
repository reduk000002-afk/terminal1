-- Создаём функцию для безопасной регистрации пользователя
CREATE OR REPLACE FUNCTION public.register_user(
    p_user_key TEXT,
    p_password TEXT,
    p_email TEXT
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_result JSONB;
    v_now TIMESTAMPTZ := NOW();
BEGIN
    -- Проверяем, существует ли пользователь
    IF EXISTS (SELECT 1 FROM public.app_users WHERE email = p_email) THEN
        RETURN jsonb_build_object('success', false, 'error', 'User already exists');
    END IF;

    -- Вставляем нового пользователя
    INSERT INTO public.app_users (
        user_key,
        password,
        email,
        balance,
        level,
        created,
        updated_at,
        updated_by
    ) VALUES (
        p_user_key,
        p_password,
        p_email,
        0,
        'Стандарт',
        v_now,
        v_now,
        'admin'
    );

    RETURN jsonb_build_object('success', true, 'message', 'User registered successfully');
EXCEPTION
    WHEN OTHERS THEN
        RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;
$$;

-- Даём права на выполнение функции
GRANT EXECUTE ON FUNCTION public.register_user TO anon;
GRANT EXECUTE ON FUNCTION public.register_user TO authenticated;
