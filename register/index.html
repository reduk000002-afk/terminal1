<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: monospace; }
        body { background: #0a0e17; color: white; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #3b82f6; margin-bottom: 20px; }
        .btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 4px; }
        .log { background: #1a2332; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #2d3748; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π</h1>
        
        <div class="log" id="log"></div>
        
        <button class="btn" onclick="test1()">1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
        <button class="btn" onclick="test2()">2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É app_users</button>
        <button class="btn" onclick="test3()">3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã</button>
        <button class="btn" onclick="test4()">4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏</button>
        <button class="btn" onclick="test5()">5. –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
        
        <div class="log" id="result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wkukgnkfbxgpvlraczeu.supabase.co';
        const ANON_KEY = 'sb_publishable_11WBFNEcbspv1yDyfxq7sQ_Nl51ew5i';
        const SERVICE_KEY = 'sb_secret_-_i6bNuyDrQOrEn0JVLptQ_FQYLUDLf';
        
        const log = document.getElementById('log');
        const result = document.getElementById('result');
        
        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            log.innerHTML += `<div class="${color}">[${time}] ${msg}</div>`;
        }
        
        function showResult(msg, type = 'info') {
            result.innerHTML = `<div class="${type}">${msg}</div>`;
        }
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        async function test1() {
            addLog('–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase...');
            
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY);
                addLog('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω');
                
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
                const { data, error } = await supabase.from('app_users').select('count').limit(1);
                
                if (error) throw error;
                
                showResult('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —Ä–∞–±–æ—Ç–∞–µ—Ç!', 'success');
                addLog('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
                addLog(`‚ùå ${error.message}`, 'error');
            }
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
        async function test2() {
            addLog('–¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É app_users...');
            
            try {
                const supabase = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY);
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const { data, error } = await supabase
                    .from('app_users')
                    .select('*')
                    .limit(5);
                
                if (error) throw error;
                
                showResult(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ app_users —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –ó–∞–ø–∏—Å–µ–π: ${data.length}`, 'success');
                addLog(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–ø–∏—Å–µ–π: ${data.length}`);
                
                // –ü–æ–∫–∞–∂–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
                if (data.length > 0) {
                    addLog('üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏:');
                    Object.keys(data[0]).forEach(key => {
                        addLog(`  - ${key}: ${typeof data[0][key]}`);
                    });
                }
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã: ${error.message}`, 'error');
                addLog(`‚ùå ${error.message}`, 'error');
            }
        }
        
        // 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        async function test3() {
            addLog('–¢–µ—Å—Ç 3: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã...');
            
            try {
                // –ü—Ä–æ–±—É–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
                const testData = [
                    {
                        user_key: 'test_' + Date.now(),
                        password: 'test123',
                        updated_by: 'diagnostic'
                    }
                ];
                
                const supabase = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY);
                const { data, error } = await supabase
                    .from('app_users')
                    .insert(testData);
                
                if (error) {
                    if (error.message.includes('email')) {
                        addLog('‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–æ–ª–µ email, –ø—Ä–æ–±—É–µ–º —Å email...');
                        
                        testData[0].email = 'test' + Date.now() + '@test.com';
                        const { data, error } = await supabase
                            .from('app_users')
                            .insert(testData);
                        
                        if (error) throw error;
                        
                        showResult('‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å: user_key + password + email', 'success');
                    } else {
                        throw error;
                    }
                } else {
                    showResult('‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å: user_key + password', 'success');
                }
                
                addLog('‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞');
                
            } catch (error) {
                showResult(`‚ùå –û—à–∏–±–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: ${error.message}`, 'error');
                addLog(`‚ùå ${error.message}`, 'error');
            }
        }
        
        // 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏
        async function test4() {
            addLog('–¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞...');
            
            // –¢–µ—Å—Ç anon –∫–ª—é—á–∞
            try {
                const supabaseAnon = window.supabase.createClient(SUPABASE_URL, ANON_KEY);
                const { error } = await supabaseAnon.from('app_users').select('count').limit(1);
                
                if (error && error.message.includes('permission')) {
                    addLog('‚úÖ Anon –∫–ª—é—á: —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (–æ–∂–∏–¥–∞–µ–º–æ)');
                } else {
                    addLog('‚ÑπÔ∏è Anon –∫–ª—é—á: ' + (error ? error.message : '—Ä–∞–±–æ—Ç–∞–µ—Ç'));
                }
            } catch (e) {
                addLog(`‚ùå Anon –∫–ª—é—á: ${e.message}`, 'error');
            }
            
            // –¢–µ—Å—Ç service –∫–ª—é—á–∞
            try {
                const supabaseService = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY);
                const { error } = await supabaseService.from('app_users').select('count').limit(1);
                
                if (error) {
                    addLog(`‚ùå Service –∫–ª—é—á: ${error.message}`, 'error');
                } else {
                    addLog('‚úÖ Service –∫–ª—é—á: —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á—Ç–µ–Ω–∏–µ');
                }
            } catch (e) {
                addLog(`‚ùå Service –∫–ª—é—á: ${e.message}`, 'error');
            }
        }
        
        // 5. –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å
        async function test5() {
            addLog('–¢–µ—Å—Ç 5: –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø–∏—Å–∏...');
            
            const testEmail = 'test' + Date.now() + '@test.com';
            const testUser = 'testuser' + Date.now();
            
            const testCases = [
                {
                    name: '–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä',
                    data: { user_key: testUser, password: 'test123', updated_by: 'test' }
                },
                {
                    name: '–° email',
                    data: { user_key: testUser, password: 'test123', email: testEmail, updated_by: 'test' }
                },
                {
                    name: '–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä',
                    data: { 
                        user_key: testUser, 
                        password: 'test123', 
                        email: testEmail,
                        level: '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
                        withdraw_type: 'normal',
                        updated_by: 'test'
                    }
                }
            ];
            
            const supabase = window.supabase.createClient(SUPABASE_URL, SERVICE_KEY);
            
            for (let testCase of testCases) {
                addLog(`–ü—Ä–æ–±—É–µ–º: ${testCase.name}...`);
                
                try {
                    const { data, error } = await supabase
                        .from('app_users')
                        .insert([testCase.data]);
                    
                    if (error) {
                        addLog(`‚ùå ${testCase.name}: ${error.message}`, 'error');
                    } else {
                        addLog(`‚úÖ ${testCase.name}: –£—Å–ø–µ—à–Ω–æ!`, 'success');
                        showResult(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: ${testCase.name}`, 'success');
                        return;
                    }
                } catch (error) {
                    addLog(`‚ùå ${testCase.name}: ${error.message}`, 'error');
                }
            }
        }
        
        // –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫
        window.addEventListener('load', () => {
            addLog('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞...');
            addLog(`URL: ${SUPABASE_URL}`);
            addLog(`Service –∫–ª—é—á: ${SERVICE_KEY.substring(0, 20)}...`);
        });
    </script>
</body>
</html>
